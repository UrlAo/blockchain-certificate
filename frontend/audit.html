<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å®¡è®¡äº‹ä»¶ - åŒºå—é“¾è¯ä¹¦ç³»ç»Ÿ</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="config.js"></script>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="title">ğŸ§¾ å®¡è®¡äº‹ä»¶</div>
      <div class="status">
        <button class="link-btn" onclick="location.href='index.html'">è¿”å›é¦–é¡µ</button>
        <span id="netBadge" class="badge" style="display:none"></span>
      </div>
    </div>

    <div class="card">
      <h3>äº‹ä»¶åˆ—è¡¨</h3>
      <div class="row">
        <button class="btn-primary" onclick="loadEvents()">åŠ è½½äº‹ä»¶</button>
        <button class="btn-secondary" onclick="exportCSV()">å¯¼å‡º CSV</button>
        <button class="btn-secondary" onclick="exportJSON()">å¯¼å‡º JSON</button>
      </div>
      <div id="summary" class="hint"></div>
      <div id="events"></div>
    </div>
  </div>

  <script>
    let provider, contract, cached = []
    const LOCAL_CHAIN_ID_HEX = '0x7A69'
    const LOCAL_RPC_URL = 'http://127.0.0.1:8545'

    async function init() {
      if (typeof window.ethereum === 'undefined') { alert('è¯·å®‰è£…MetaMask'); return }
      const currentChain = await window.ethereum.request({ method: 'eth_chainId' })
      if (currentChain !== LOCAL_CHAIN_ID_HEX) {
        try {
          await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: LOCAL_CHAIN_ID_HEX }] })
        } catch (e) {
          if (e && e.code === 4902) {
            await window.ethereum.request({ method: 'wallet_addEthereumChain', params: [{ chainId: LOCAL_CHAIN_ID_HEX, chainName: 'Hardhat Local', rpcUrls: [LOCAL_RPC_URL], nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 } }] })
          }
        }
      }
      provider = new ethers.providers.Web3Provider(window.ethereum)
      await provider.send('eth_requestAccounts', [])
      const network = await provider.getNetwork()
      const netBadge = document.getElementById('netBadge')
      netBadge.style.display = 'inline-block'
      netBadge.innerText = `chainId: ${network.chainId}`
      const res = await fetch(CONFIG.ABI_URL)
      const abi = await res.json()
      contract = new ethers.Contract(CONFIG.CONTRACT_ADDRESS.trim(), abi, provider)
    }

    async function loadEvents() {
      if (!contract) await init()
      const status = document.getElementById('summary')
      status.innerText = 'åŠ è½½ä¸­...'
      const fromBlock = 0
      const toBlock = 'latest'
      let issued = [], revoked = [], added = [], removed = [], batchRoots = []
      try { issued = await contract.queryFilter(contract.filters.CertificateIssued(), fromBlock, toBlock) } catch(_){}
      try { revoked = await contract.queryFilter(contract.filters.CertificateRevoked(), fromBlock, toBlock) } catch(_){}
      try { added = await contract.queryFilter(contract.filters.IssuerAdded(), fromBlock, toBlock) } catch(_){}
      try { removed = await contract.queryFilter(contract.filters.IssuerRemoved(), fromBlock, toBlock) } catch(_){}
      try { batchRoots = await contract.queryFilter(contract.filters.BatchRootIssued(), fromBlock, toBlock) } catch(_){}

      cached = []
      const push = (type, ev) => {
        cached.push({
          type,
          blockNumber: ev.blockNumber,
          txHash: ev.transactionHash,
          args: ev.args && Array.from(ev.args)
        })
      }
      issued.forEach(e=>push('CertificateIssued', e))
      revoked.forEach(e=>push('CertificateRevoked', e))
      added.forEach(e=>push('IssuerAdded', e))
      removed.forEach(e=>push('IssuerRemoved', e))
      batchRoots.forEach(e=>push('BatchRootIssued', e))

      cached.sort((a,b)=>a.blockNumber-b.blockNumber)
      status.innerText = `å…± ${cached.length} æ¡äº‹ä»¶`
      const rows = cached.length ? cached.map(ev=>`
        <div class="card">
          <div class="row"><strong>${ev.type}</strong> <span class="hint">block: ${ev.blockNumber}</span></div>
          <div class="hint">tx: ${ev.txHash}</div>
          <div>${renderArgs(ev)}</div>
        </div>
      `).join('') : '<div class="card info">å½“å‰æ²¡æœ‰äº‹ä»¶è®°å½•</div>'
      document.getElementById('events').innerHTML = rows
    }

    function renderArgs(ev){
      if (!ev.args) return ''
      return ev.args.map((v,i)=>`arg${i}: ${v}`).join('<br>')
    }

    function exportCSV(){
      if (!cached.length) return
      const header = ['type','blockNumber','txHash','args']
      const lines = [header.join(',')].concat(cached.map(e=>`${e.type},${e.blockNumber},${e.txHash},"${(e.args||[]).join('|')}"`))
      download('events.csv', lines.join('\n'))
    }
    function exportJSON(){
      if (!cached.length) return
      download('events.json', JSON.stringify(cached, null, 2))
    }
    function download(name, content){
      const blob = new Blob([content], {type:'text/plain;charset=utf-8'})
      const url = URL.createObjectURL(blob)
      const a = document.createElement('a')
      a.href = url; a.download = name; a.click();
      URL.revokeObjectURL(url)
    }

    window.onload = init
  </script>
</body>
</html>