<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éªŒè¯è¯ä¹¦ - åŒºå—é“¾è¯ä¹¦ç³»ç»Ÿ</title>
 <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
 <script src="config.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; }
        .back-btn { background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; margin-bottom: 20px; }
        button { background: #007bff; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; width: 100%; margin: 10px 0; }
        #result { margin: 20px 0; padding: 15px; border-radius: 5px; }
        .valid { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .invalid { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .cert-info { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; padding: 10px; margin: 10px 0; }
</style>
<link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
      <div class="header">
        <div class="title">ğŸ” éªŒè¯è¯ä¹¦</div>
        <div class="status">
          <button class="link-btn" onclick="location.href='index.html'">è¿”å›é¦–é¡µ</button>
          <span id="netBadge" class="badge" style="display:none"></span>
        </div>
      </div>
      <div class="card">
        <h3>æ­¥éª¤ 1ï¼šä¸Šä¼ éœ€è¦éªŒè¯çš„æ–‡ä»¶</h3>
        <div class="form-group">
          <input type="file" id="certFile" accept=".pdf,.jpg,.jpeg,.png">
        </div>
        <div class="row"><button class="btn-primary" onclick="verifyCertificate()">éªŒè¯è¯ä¹¦çœŸä¼ª</button></div>
        <div id="hashResult"></div>
      </div>
      <div id="result"></div>
    </div>

    <script>
        let provider, contract;
        const contractAddress = '0x5FbDB2315678afecb367f032d93F642f64180aa3'; // éƒ¨ç½²åæ›¿æ¢ä¸ºå®é™…åœ°å€
        const contractABI = [  {
    "inputs": [],
    "stateMutability": "nonpayable",
    "type": "constructor"
  },
  {
    "anonymous": false,
    "inputs": [
      {
        "indexed": true,
        "internalType": "bytes32",
        "name": "certHash",
        "type": "bytes32"
      },
      {
        "indexed": false,
        "internalType": "string",
        "name": "studentId",
        "type": "string"
      },
      {
        "indexed": false,
        "internalType": "string",
        "name": "studentName",
        "type": "string"
      }
    ],
    "name": "CertificateIssued",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      {
        "indexed": true,
        "internalType": "bytes32",
        "name": "certHash",
        "type": "bytes32"
      },
      {
        "indexed": false,
        "internalType": "bool",
        "name": "isValid",
        "type": "bool"
      }
    ],
    "name": "CertificateVerified",
    "type": "event"
  },
  {
    "inputs": [],
    "name": "admin",
    "outputs": [
      {
        "internalType": "address",
        "name": "",
        "type": "address"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "bytes32",
        "name": "",
        "type": "bytes32"
      }
    ],
    "name": "certificates",
    "outputs": [
      {
        "internalType": "string",
        "name": "studentId",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "studentName",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "degree",
        "type": "string"
      },
      {
        "internalType": "uint256",
        "name": "issueDate",
        "type": "uint256"
      },
      {
        "internalType": "bool",
        "name": "isIssued",
        "type": "bool"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "bytes32",
        "name": "_certHash",
        "type": "bytes32"
      },
      {
        "internalType": "string",
        "name": "_studentId",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "_studentName",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "_degree",
        "type": "string"
      }
    ],
    "name": "issueCertificate",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "bytes32",
        "name": "_certHash",
        "type": "bytes32"
      }
    ],
    "name": "simpleVerify",
    "outputs": [
      {
        "internalType": "bool",
        "name": "",
        "type": "bool"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "bytes32",
        "name": "_certHash",
        "type": "bytes32"
      }
    ],
    "name": "verifyCertificate",
    "outputs": [
      {
        "internalType": "bool",
        "name": "",
        "type": "bool"
      },
      {
        "internalType": "string",
        "name": "",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "",
        "type": "string"
      },
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  } ];

        // åˆå§‹åŒ–ä»¥å¤ªåŠè¿æ¥ï¼ˆåªè¯»æ¨¡å¼ï¼‰
        const LOCAL_CHAIN_ID_HEX = '0x7A69';
        const LOCAL_RPC_URL = 'http://127.0.0.1:8545';

        async function initEthereum() {
            if (typeof window.ethereum !== 'undefined') {
                const currentChain = await window.ethereum.request({ method: 'eth_chainId' });
                if (currentChain !== LOCAL_CHAIN_ID_HEX) {
                    try {
                        await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: LOCAL_CHAIN_ID_HEX }] });
                    } catch (e) {
                        if (e && e.code === 4902) {
                            await window.ethereum.request({ method: 'wallet_addEthereumChain', params: [{ chainId: LOCAL_CHAIN_ID_HEX, chainName: 'Hardhat Local', rpcUrls: [LOCAL_RPC_URL], nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 } }] });
                        }
                    }
                }
                provider = new ethers.providers.Web3Provider(window.ethereum);
                await loadAbiIfNeeded();
                const abiToUse = window.contractABI || contractABI;
                const addrToUse = ((typeof CONFIG !== 'undefined' && CONFIG.CONTRACT_ADDRESS) ? CONFIG.CONTRACT_ADDRESS : contractAddress).trim();
                contract = new ethers.Contract(addrToUse, abiToUse, provider);
                const network = await provider.getNetwork();
                const netBadge = document.getElementById('netBadge');
                netBadge.style.display = 'inline-block';
                netBadge.innerText = `chainId: ${network.chainId}`;
                console.log("ä»¥å¤ªåŠè¿æ¥åˆå§‹åŒ–æˆåŠŸ");
            } else {
                alert('è¯·å®‰è£…MetaMask!');
            }
        }

        async function loadAbiIfNeeded() {
            try {
                if (!window.contractABI && typeof CONFIG !== 'undefined' && CONFIG.ABI_URL) {
                    const res = await fetch(CONFIG.ABI_URL);
                    window.contractABI = await res.json();
                }
            } catch (e) {
                console.warn('åŠ è½½ ABI å¤±è´¥ï¼Œä½¿ç”¨å†…ç½® ABI', e);
            }
        }

        // éªŒè¯è¯ä¹¦
        async function verifyCertificate() {
            const fileInput = document.getElementById('certFile');
            if (!fileInput.files[0]) {
                alert('è¯·é€‰æ‹©è¦éªŒè¯çš„æ–‡ä»¶');
                return;
            }

            try {
                document.getElementById('result').innerHTML = '<div class="info">æ­£åœ¨éªŒè¯...</div>';
                
                const file = fileInput.files[0];
                const arrayBuffer = await file.arrayBuffer();
                
                // è®¡ç®—SHA-256å“ˆå¸Œ
                const hashBuffer = await crypto.subtle.digest('SHA-256', arrayBuffer);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const fileHash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                
                document.getElementById('hashResult').innerHTML = 
                    `<div class="card"><div class="row"><strong>æ–‡ä»¶å“ˆå¸Œå€¼</strong><button class=\"btn-secondary\" onclick=\"copyText('${fileHash}')\">å¤åˆ¶</button></div><div class="code">${fileHash}</div></div>`;
                
                // å°†å“ˆå¸Œå­—ç¬¦ä¸²è½¬æ¢ä¸ºbytes32
                const hashBytes32 = '0x' + fileHash;
                
                // è°ƒç”¨åˆçº¦æŸ¥è¯¢å®Œæ•´ä¿¡æ¯
                const result = await contract.getCertificate(hashBytes32);
                const [isIssued, studentId, studentName, degree, issueDate, revoked, revokeReason, revokeDate, ipfsCid] = result;
                
                if (isIssued && !revoked) {
                    const date = new Date(Number(issueDate) * 1000).toLocaleString();
                    document.getElementById('result').innerHTML = `
                        <div class="card success">
                            <h3>âœ… è¯ä¹¦éªŒè¯é€šè¿‡ï¼</h3>
                            <div class="card">
                              <strong>è¯ä¹¦ä¿¡æ¯</strong>
                              <div>å­¦å·: ${studentId}</div>
                              <div>å§“å: ${studentName}</div>
                              <div>å­¦ä½: ${degree}</div>
                              <div>å‘è¡Œæ—¶é—´: ${date}</div>
                              ${ipfsCid ? `<div>IPFS CID: ${ipfsCid}</div>` : ''}
                            </div>
                        </div>
                    `;
                } else if (isIssued && revoked) {
                    const rDate = new Date(Number(revokeDate) * 1000).toLocaleString();
                    document.getElementById('result').innerHTML = `
                        <div class="card warn">
                            <h3>âš ï¸ è¯ä¹¦å·²æ’¤é”€</h3>
                            <div>åŸå› ï¼š${revokeReason || 'æœªæä¾›'}</div>
                            <div>æ—¶é—´ï¼š${rDate}</div>
                        </div>
                    `;
                } else {
                    document.getElementById('result').innerHTML = `
                        <div class="card error">
                            <h3>âŒ è¯ä¹¦éªŒè¯å¤±è´¥ï¼</h3>
                            <p>è¯¥è¯ä¹¦æœªåœ¨åŒºå—é“¾ä¸Šæ³¨å†Œæˆ–å·²è¢«ç¯¡æ”¹</p>
                            <p class="hint">å¯èƒ½åŸå› ï¼šä¸Šä¼ æ–‡ä»¶ä¸ç™»è®°æ–‡ä»¶ä¸ä¸€è‡´ã€å°šæœªå‘è¡Œã€ç½‘ç»œæœªè¿æ¥ã€‚</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('éªŒè¯å¤±è´¥:', error);
                document.getElementById('result').innerHTML = `<div class="card error">éªŒè¯è¿‡ç¨‹ä¸­å‡ºé”™: ${error.message}</div>`;
            }
        }
        function copyText(text){
            navigator.clipboard.writeText(text).catch(()=>{});
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = initEthereum;
    </script>
</body>
</html>