<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‘è¡Œè¯ä¹¦ - åŒºå—é“¾è¯ä¹¦ç³»ç»Ÿ</title>
   <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, button { width: 100%; padding: 10px; margin-bottom: 10px; }
        button { background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:disabled { background: #6c757d; }
        .back-btn { background: #6c757d; width: auto; padding: 8px 16px; }
        #hashResult, #status { margin: 15px 0; padding: 10px; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    </style>
</head>
<body>
    <button class="back-btn" onclick="location.href='index.html'">â† è¿”å›é¦–é¡µ</button>
    <h1>ğŸ“ å‘è¡Œè¯ä¹¦</h1>
    
    <div class="form-group">
        <label for="certFile">é€‰æ‹©è¯ä¹¦æ–‡ä»¶ (PDF/å›¾ç‰‡):</label>
        <input type="file" id="certFile" accept=".pdf,.jpg,.jpeg,.png">
    </div>
    
    <div class="form-group">
        <label for="studentId">å­¦å·:</label>
        <input type="text" id="studentId" placeholder="ä¾‹å¦‚: 202301001">
    </div>
    
    <div class="form-group">
        <label for="studentName">å­¦ç”Ÿå§“å:</label>
        <input type="text" id="studentName" placeholder="ä¾‹å¦‚: å¼ ä¸‰">
    </div>
    
    <div class="form-group">
        <label for="degree">å­¦ä½ä¿¡æ¯:</label>
        <input type="text" id="degree" placeholder="ä¾‹å¦‚: è®¡ç®—æœºç§‘å­¦å­¦å£«">
    </div>
    
    <button onclick="calculateHash()">è®¡ç®—æ–‡ä»¶å“ˆå¸Œ</button>
    
    <div id="hashResult"></div>
    
    <button id="issueBtn" onclick="issueCertificate()" disabled>å‘è¡Œè¯ä¹¦åˆ°åŒºå—é“¾</button>
    
    <div id="status"></div>

    <script>
        let currentFileHash = '';
        let provider, signer, contract;
        const contractAddress = '0x5FbDB2315678afecb367f032d93F642f64180aa3'; // éƒ¨ç½²åæ›¿æ¢ä¸ºå®é™…åœ°å€
        const contractABI = [  {
    "inputs": [],
    "stateMutability": "nonpayable",
    "type": "constructor"
  },
  {
    "anonymous": false,
    "inputs": [
      {
        "indexed": true,
        "internalType": "bytes32",
        "name": "certHash",
        "type": "bytes32"
      },
      {
        "indexed": false,
        "internalType": "string",
        "name": "studentId",
        "type": "string"
      },
      {
        "indexed": false,
        "internalType": "string",
        "name": "studentName",
        "type": "string"
      }
    ],
    "name": "CertificateIssued",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      {
        "indexed": true,
        "internalType": "bytes32",
        "name": "certHash",
        "type": "bytes32"
      },
      {
        "indexed": false,
        "internalType": "bool",
        "name": "isValid",
        "type": "bool"
      }
    ],
    "name": "CertificateVerified",
    "type": "event"
  },
  {
    "inputs": [],
    "name": "admin",
    "outputs": [
      {
        "internalType": "address",
        "name": "",
        "type": "address"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "bytes32",
        "name": "",
        "type": "bytes32"
      }
    ],
    "name": "certificates",
    "outputs": [
      {
        "internalType": "string",
        "name": "studentId",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "studentName",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "degree",
        "type": "string"
      },
      {
        "internalType": "uint256",
        "name": "issueDate",
        "type": "uint256"
      },
      {
        "internalType": "bool",
        "name": "isIssued",
        "type": "bool"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "bytes32",
        "name": "_certHash",
        "type": "bytes32"
      },
      {
        "internalType": "string",
        "name": "_studentId",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "_studentName",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "_degree",
        "type": "string"
      }
    ],
    "name": "issueCertificate",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "bytes32",
        "name": "_certHash",
        "type": "bytes32"
      }
    ],
    "name": "simpleVerify",
    "outputs": [
      {
        "internalType": "bool",
        "name": "",
        "type": "bool"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "bytes32",
        "name": "_certHash",
        "type": "bytes32"
      }
    ],
    "name": "verifyCertificate",
    "outputs": [
      {
        "internalType": "bool",
        "name": "",
        "type": "bool"
      },
      {
        "internalType": "string",
        "name": "",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "",
        "type": "string"
      },
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  } ];

        // åˆå§‹åŒ–ä»¥å¤ªåŠè¿æ¥
        async function initEthereum() {
            if (typeof window.ethereum !== 'undefined') {
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                contract = new ethers.Contract(contractAddress, contractABI, signer);
                console.log("ä»¥å¤ªåŠè¿æ¥åˆå§‹åŒ–æˆåŠŸ");
            } else {
                alert('è¯·å®‰è£…MetaMask!');
            }
        }

        // è®¡ç®—æ–‡ä»¶å“ˆå¸Œ
        async function calculateHash() {
            const fileInput = document.getElementById('certFile');
            if (!fileInput.files[0]) {
                alert('è¯·é€‰æ‹©æ–‡ä»¶');
                return;
            }

            const file = fileInput.files[0];
            const arrayBuffer = await file.arrayBuffer();
            
            // è®¡ç®—SHA-256å“ˆå¸Œ
            const hashBuffer = await crypto.subtle.digest('SHA-256', arrayBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            currentFileHash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            
            document.getElementById('hashResult').innerHTML = 
                `<div class="info"><strong>æ–‡ä»¶å“ˆå¸Œå€¼:</strong><br><code>${currentFileHash}</code></div>`;
            document.getElementById('issueBtn').disabled = false;
        }

        // å‘è¡Œè¯ä¹¦
        async function issueCertificate() {
            if (!currentFileHash) {
                alert('è¯·å…ˆè®¡ç®—æ–‡ä»¶å“ˆå¸Œ');
                return;
            }

            const studentId = document.getElementById('studentId').value;
            const studentName = document.getElementById('studentName').value;
            const degree = document.getElementById('degree').value;

            if (!studentId || !studentName || !degree) {
                alert('è¯·å¡«å†™æ‰€æœ‰ä¿¡æ¯');
                return;
            }

            try {
                document.getElementById('status').innerHTML = '<div class="info">æ­£åœ¨å‘è¡Œè¯ä¹¦...</div>';
                
                // å°†å“ˆå¸Œå­—ç¬¦ä¸²è½¬æ¢ä¸ºbytes32
                const hashBytes32 = '0x' + currentFileHash;
                
                const tx = await contract.issueCertificate(hashBytes32, studentId, studentName, degree);
                document.getElementById('status').innerHTML = '<div class="info">äº¤æ˜“å·²æäº¤ï¼Œç­‰å¾…ç¡®è®¤...</div>';
                
                await tx.wait();
                document.getElementById('status').innerHTML = '<div class="success">âœ… è¯ä¹¦å‘è¡ŒæˆåŠŸï¼</div>';
                
            } catch (error) {
                console.error('å‘è¡Œå¤±è´¥:', error);
                document.getElementById('status').innerHTML = `<div class="error">âŒ å‘è¡Œå¤±è´¥: ${error.message}</div>`;
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = initEthereum;
    </script>
</body>
</html>